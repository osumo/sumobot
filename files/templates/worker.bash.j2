#! /usr/bin/env bash

# this script detects when its contents have been modified (presumably by a
# reconfiguration via ansible), and will reconfigure the running girder instance
# if its current version has changed from the most recent one.
initialization_path="worker_init/$( cat "$0" | shasum | cut -d\  -f 1 )"

cd "$( dirname "$0" )"

# needed to make sure girder-worker stops, actually REALLY **STOPS**!
(
    function pid_walk () {
        echo "$1"
        for pid in $(ps -o pid= --ppid "$1") ; do
            pid_walk "$pid"
        done
    }

    pid="$( cat ./girder_worker.pid2 || true )"
    pids="$( pid_walk "$pid" || true )"
    kill $pid || true
    sleep 5 || true
    kill -9 $pids || true
) &> /dev/null

echo $$ > ./girder_worker.pid2

source scripts/env
export NVM_DIR=/opt/nvm
source /opt/nvm/nvm.sh
nvm use v6

pushd girder_worker
pip install -e '.'
rsync -avz --exclude .git ../sumo_io ./girder_worker/plugins
exec girder-worker
